<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üïµÔ∏è Webhook Inspector</title>
    <style>
        body { font-family: monospace; background-color: #1e1e1e; color: #d4d4d4; margin: 0; padding: 20px; }
        h1 { color: #569cd6; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .log-container { display: flex; flex-direction: column-reverse; /* Lo m√°s nuevo arriba si insertamos al final */ gap: 10px; }

        .log-entry { background-color: #252526; border: 1px solid #333; border-radius: 5px; padding: 10px; animation: flash 1s; }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 5px; color: #858585; font-size: 0.9em; border-bottom: 1px solid #3c3c3c; padding-bottom: 5px; }
        .log-id { color: #b5cea8; font-weight: bold; }
        .log-time { color: #ce9178; }

        pre { margin: 0; color: #9cdcfe; white-space: pre-wrap; word-wrap: break-word; }

        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .live { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }

        @keyframes flash {
            0% { background-color: #37373d; }
            100% { background-color: #252526; }
        }
    </style>
</head>
<body>

    <h1>
        <span class="status-dot live"></span> Webhook Inspector (Live)
        <span style="float: right; font-size: 0.5em; margin-top: 10px;">Autorefresh cada 3s</span>
    </h1>

    <div id="log-container" class="log-container">
        <div style="text-align: center; color: #666; padding: 20px;">Esperando eventos...</div>
    </div>

    <script>
        let lastId = 0;
        const container = document.getElementById('log-container');

        function fetchLogs() {
            fetch(`/whatsapp/inspector/api/?last_id=${lastId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs.length > 0) {
                        // Limpiar mensaje de "Esperando..." si es la primera carga real
                        if (lastId === 0) container.innerHTML = '';

                        data.logs.forEach(log => {
                            lastId = Math.max(lastId, log.id);

                            const entry = document.createElement('div');
                            entry.className = 'log-entry';

                            // Formatear JSON bonito
                            const prettyJson = JSON.stringify(log.payload, null, 2);

                            entry.innerHTML = `
                                <div class="log-header">
                                    <span class="log-id">#${log.id}</span>
                                    <span class="log-time">${log.created_at}</span>
                                </div>
                                <pre>${prettyJson}</pre>
                            `;

                            // Insertar al principio (para ver lo m√°s nuevo arriba)
                            container.insertBefore(entry, container.firstChild);
                        });
                    }
                })
                .catch(err => console.error("Error fetching logs:", err));
        }

        // Consultar cada 3 segundos
        setInterval(fetchLogs, 3000);
        fetchLogs(); // Primera llamada inmediata
    </script>

</body>
</html>